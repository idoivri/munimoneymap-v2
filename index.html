
<!DOCTYPE html>
<html>
<head>
	<title>Israeli Government Citizen Investment Map</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- source data from: https://docs.google.com/spreadsheets/d/1pC4OYhxWZZeLyLYbSC9da1o8ua0qOdz-exmQupMbFa0/edit#gid=1677260747 -->

	<!--bootstrap css -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

	<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />

	<link rel="stylesheet" href="css/style.css" />

	<!--jquery js-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<!--bootstrap js -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

	<script src="dist/papaparse.min.js"></script>
<!-- 	 <script src="dist/PruneCluster.js"></script> -->
	<!--
	<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
	<script src="http://jquery-csv.googlecode.com/git/src/jquery.csv.js"></script>
	-->

</head>
<body>


	<!-- <div id="header-wrap">
    	<h3>מפת הארנונה</h3>
  		
	</div> -->



	<div id="map"></div>
		

	<script>

		muni2ContentDict = {};

		// Create a map in the div #map
		
		L.mapbox.accessToken = 'pk.eyJ1IjoiaWRvaXZyaSIsImEiOiJtSDZZd0dzIn0.AGwQs7X6LESuybqo6fUVpg';
		var map = L.mapbox.map('map').setView([32.06425, 34.769722], 9);

		L.mapbox.styleLayer('mapbox://styles/idoivri/ciq965t0m007xerm4qynst85d').addTo(map);
		
		function getColor(d) {
			return d > 10000 ? '#1550a3' :
			       d > 8000  ? '#BD0026' :
			       d > 6000  ? '#E31A1C' :
			       d > 4000  ? '#FC4E2A' :
			       d > 2000   ? '#FD8D3C' :
			       // d > 20   ? '#FEB24C' :
			       // d > 10   ? '#FED976' :
			                  '#FFEDA0';
		}

		//add control that shows interactive data
		var info = L.control();

		info.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'info');
			this.update();
			return this._div;
		};

		info.update = function (name) {

			var props = muni2ContentDict[name];
			if (!props) {
				console.log("invalid muni name, can't update the info control");
				return;
			}
			
			this._div.innerHTML = '<h4>השקעה לתושב</h4>' +  (props ?
				'<b>' + props.muniHebName + '</b><br />' + props.investment + ' ש״ח</sup>'
				: 'עברו עם העכבר מעל עיר');
		};

		info.addTo(map);

		function resetHighlight(e) {
			geojson.resetStyle(e.target);
			info.update();
		}

		function highlightFeature(e) {
			var layer = e.target;

			console.log("layer! ",layer);

			// layer.setStyle({
			// 	weight: 5,
			// 	color: '#666',
			// 	dashArray: '',
			// 	fillOpacity: 0.7
			// });

			if (!L.Browser.ie && !L.Browser.opera) {
				layer.bringToFront();
			}

			info.update(layer.name);
		}



		var legend = L.control({position: 'bottomright'});

				legend.onAdd = function (map) {

					var div = L.DomUtil.create('div', 'info legend'),
						grades = [0,2000, 4000, 6000, 8000, 10000],
						labels = [],
						from, to;

					for (var i = 0; i < grades.length; i++) {
						from = grades[i];
						to = grades[i + 1];

						labels.push(
							'<i style="background:' + getColor(from + 1) + '"></i> ' +
							from + (to ? '&ndash;' + to : '+'));
					}

					div.innerHTML = labels.join('<br>');
					return div;
		};

		legend.addTo(map);



		Papa.parse("./data/munis-arnona.csv", {
			header: false,
			download: true,
			complete: function(results) {

				//console.log(results);
				var len = results.data.length;

				console.log(results.data[1]);

				for (var i=1; i<len; i++){
					//console.log(results.data[i]);
					line = results.data[i];

			        //console.log("COORDS: " + line[12] + "," + line[11]);
			        if (line[0]===undefined || line[0]==="") {
			        	console.log("No hebrew name for municipalitiy");	
			        }
			        else if (line[1]===undefined || line[1]==="") {
			        	console.log("No english name for municipality "+line[0]+", can't extract polygon!");
			        }
			        else if (line[15]==="" || line[15]===undefined) {
			        	console.log("No financial detail for "+line[0]);
			        }
			        else {

			        	name = line[1]; //url name relies 



						var urlString = 'https://cdn.rawgit.com/idoivri/israel-municipalities-polygons/master/'+name+'/'+name+'.geojson';

						var getDifferenceColor = function (sum) {
							//console.log("got difference ",sum);
							var d = Number.parseFloat(sum);
							console.log("got difference: ", d);
						    return d > 10000  ? '#1550a3' :
						           d > 8000  ? '#fee5d9' :
						           d > 6000  ? '#fcbba1' :
						           d < 4000  ? '#fc9272' :
						           d < 2000   ? '#fb6a4a' :
						           // d < 25   ? '#de2d26' :
						                      '#a50f15';
						}

			        	var layerStyle = {
								        fillColor: getColor(line[15]),
								        color: 'black',
								        weight: 0.5,
								        fillOpacity: 0.6,
									};



						muni2ContentDict[name] = {
							muniHebName: line[0],
							layerStyle: layerStyle,
							// normative_arnona: line[7],
							// real_arnona: line[9],
							// difference_arnona: line[9]-line[7],
							investment: line[15]
						};
						




						// $.ajax({
						// 		  url: urlString,
						// 		  data: layerStyle,
								 
						// 		  success: function (data) {
						// 		  		console.log("success (url):",this.url);
						// 		  		geoJsonLayerData = data;
						// 		  }
						// 		});

						// // var success = function (layerStyle, success, data) {


						 $.get(urlString, layerStyle, function(data, success) {


						 	if (success !== "success") {
						 		console.log("$.get() did not return success!");
						 		return;
						 	}
							
						  	if (!data) {
								console.log("did not get geoJsonLayerData!");
								return;
							}

							var url = this.url;

							var pathArray = url.split( '/' );
							// console.log(pathArray);
							// console.log(pathArray[6]);
							var muniName = pathArray[6];

							var muniObject = muni2ContentDict[muniName];
							if (!muniObject) {
								console.log("could not find muni object in dict!, muniName=",muniName);
							}

							var geojsonLayer = new L.GeoJSON(data, {style: muniObject.layerStyle}); 

					        if (!geojsonLayer) {
					        	console.log("coulnd't create get layer for: "+muniName);
					        	return;
					        }

						var content = "<b>רשות מקומית: "+muniObject.muniHebName+"</b><br/>"+
											        				"השקעה בתושב: "+muniObject.investment+" ש״ח<br/>";

					        // var content = "<b>רשות מקומית: "+muniObject.muniHebName+"</b><br/>"+
					        // 				"תעריף נורמטיבי למגורים (ש״ח למ״ר ממוצע): "+muniObject.normative_arnona+" ש״ח<br/>"+
					        // 				"תעריף בפועל (ש״ח למ״ר ממוצע): "+muniObject.real_arnona+" ש״ח<br/>"+
					        // 				"<b>"+"הפרש התעריף בין המצוי לרצוי:<span dir='ltr'> "+muniObject.difference_arnona.toFixed(0)+" </span> ש״ח</b><br/>"; 

					        geojsonLayer.bindPopup(content);

					        geojsonLayer.name = muniName;

							geojsonLayer.on({
									mouseover: highlightFeature,
									mouseout: resetHighlight,
									
							});

					        map.addLayer(geojsonLayer);

						});
					}

						

					
				}
				
			}
		});





	</script>
</body>
</html>
